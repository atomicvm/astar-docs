"use strict";(self.webpackChunkdocs_1=self.webpackChunkdocs_1||[]).push([[7096],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=u(n),d=a,g=m["".concat(s,".").concat(d)]||m[d]||p[d]||o;return n?r.createElement(g,i(i({ref:t},c),{},{components:n})):r.createElement(g,i({ref:t},c))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5254:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return p}});var r=n(7462),a=n(3366),o=(n(7294),n(3905)),i=["components"],l={sidebar_position:6},s="6. Configuration",u={unversionedId:"nodes/ultimateguide/configuration",id:"nodes/ultimateguide/configuration",title:"6. Configuration",description:"This will be a lot of copy/paste but don't be lazy and try to understand what we are doing here.",source:"@site/docs/nodes/ultimateguide/configuration.md",sourceDirName:"nodes/ultimateguide",slug:"/nodes/ultimateguide/configuration",permalink:"/astar-docs/docs/nodes/ultimateguide/configuration",editUrl:"https://github.com/AstarNetwork/astar-docs/tree/main/docs/nodes/ultimateguide/configuration.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"5. Node Monitoring",permalink:"/astar-docs/docs/nodes/ultimateguide/node_monitoring"},next:{title:"7. Services",permalink:"/astar-docs/docs/nodes/ultimateguide/services"}},c={},p=[{value:"Prometheus",id:"prometheus",level:3},{value:"Alert rules",id:"alert-rules",level:3},{value:"Process exporter",id:"process-exporter",level:3},{value:"Gmail setup",id:"gmail-setup",level:3},{value:"Alert Manager",id:"alert-manager",level:3}],m={toc:p};function d(e){var t=e.components,n=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"6-configuration"},"6. Configuration"),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"This will be a lot of copy/paste but don't be lazy and try to understand what we are doing here."))),(0,o.kt)("h3",{id:"prometheus"},"Prometheus"),(0,o.kt)("p",null,"Let\u2019s edit the ",(0,o.kt)("strong",{parentName:"p"},"Prometheus config file")," and add all the modules to it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"sudo nano /etc/prometheus/prometheus.yml\n")),(0,o.kt)("p",null,"Add the following code to the file and save ",(0,o.kt)("inlineCode",{parentName:"p"},"ctrl+o")," ",(0,o.kt)("inlineCode",{parentName:"p"},"ctrl+x"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'global:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n\nrule_files:\n  - \'rules.yml\'\n\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets:\n      - localhost:9093\n\nscrape_configs:\n  - job_name: "prometheus"\n    scrape_interval: 5s\n    static_configs:\n      - targets: ["localhost:9090"]\n  - job_name: "substrate_node"\n    scrape_interval: 5s\n    static_configs:\n      - targets: ["localhost:9615"]\n  - job_name: "node_exporter"\n    scrape_interval: 5s\n    static_configs:\n      - targets: ["localhost:9100"]\n  - job_name: "process-exporter"\n    scrape_interval: 5s\n    static_configs:\n      - targets: ["localhost:9256"]\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"scrape_interval")," defines how often Prometheus scrapes targets, while ",(0,o.kt)("inlineCode",{parentName:"li"},"evaluation_interval")," controls how often the software will evaluate the rules."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"rule_files")," set the location of Alert manager rules we will add next."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"alerting")," contains the alert manager target."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"scrape_configs")," contain the services Prometheus will monitor.")),(0,o.kt)("h3",{id:"alert-rules"},"Alert rules"),(0,o.kt)("p",null,"Let\u2019s create the ",(0,o.kt)("inlineCode",{parentName:"p"},"rules.yml")," file this will set the ",(0,o.kt)("strong",{parentName:"p"},"rules for Alert Manager"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"sudo touch /etc/prometheus/rules.yml\nsudo nano /etc/prometheus/rules.yml\n")),(0,o.kt)("p",null,"We are going to create ",(0,o.kt)("strong",{parentName:"p"},"2 basic rules")," that will trigger an alert in case the instance is down or the CPU usage crosses 80%. ",(0,o.kt)("strong",{parentName:"p"},"Add the following lines and save the file:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'groups:\n  - name: alert_rules\n    rules:\n      - alert: InstanceDown\n        expr: up == 0\n        for: 5m\n        labels:\n          severity: critical\n        annotations:\n          summary: "Instance $labels.instance down"\n          description: "[{{ $labels.instance }}] of job [{{ $labels.job }}] has been down for more than 1 minute."\n\n      - alert: HostHighCpuLoad\n        expr: 100 - (avg by(instance)(rate(node_cpu_seconds_total{mode="idle"}[2m])) * 100) > 80\n        for: 0m\n        labels:\n          severity: warning\n        annotations:\n          summary: Host high CPU load (instance Astar Node)\n          description: "CPU load is > 80%\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}"\n')),(0,o.kt)("p",null,"The criteria for ",(0,o.kt)("strong",{parentName:"p"},"triggering an alert")," are set in the ",(0,o.kt)("inlineCode",{parentName:"p"},"expr:")," part. To create your own alerts, you\u2019re going to have to learn and test the different variables provided to Prometheus by the services we are setting up. There is (almost) an infinite number of possibilities to ",(0,o.kt)("strong",{parentName:"p"},"personalize your alerts"),"."),(0,o.kt)("p",null,"As this part can be time-consuming to learn and build, you can find a summary ",(0,o.kt)("a",{parentName:"p",href:"https://pastebin.com/96wbiQN8"},"list of alerts we like to use"),".  Feel free to share your Alert file with the community. You should also have a look at ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/tree/master/.maintain/monitoring/alerting-rules"},"alerts provided by Parity"),"."),(0,o.kt)("p",null,"Then, check the ",(0,o.kt)("strong",{parentName:"p"},"rules file"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"promtool check rules /etc/prometheus/rules.yml\n")),(0,o.kt)("p",null,"And finally, check the ",(0,o.kt)("strong",{parentName:"p"},"Prometheus config file"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"promtool check config /etc/prometheus/prometheus.yml\n")),(0,o.kt)("center",null,(0,o.kt)("img",{src:"https://i.imgur.com/AQqiXjm.png",border:"1"})),(0,o.kt)("h3",{id:"process-exporter"},"Process exporter"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Process exporter")," needs a little ",(0,o.kt)("strong",{parentName:"p"},"config file")," to be told which processes they should take into account:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo touch /etc/process-exporter/config.yml\nsudo nano /etc/process-exporter/config.yml\n")),(0,o.kt)("p",null,"Add the following code to the file and save:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"process_names: \n  - name: \"{{.Comm}}\" \n    cmdline: \n    - '.+'\n")),(0,o.kt)("h3",{id:"gmail-setup"},"Gmail setup"),(0,o.kt)("p",null,"To allow AlertManager to send an email to you, you will need to generate something called an ",(0,o.kt)("inlineCode",{parentName:"p"},"app password")," in your Gmail account. For details, click ",(0,o.kt)("a",{parentName:"p",href:"https://support.google.com/accounts/answer/185833?hl=en"},"here")," to follow the whole setup."),(0,o.kt)("p",null,"You should see something like the below:"),(0,o.kt)("center",null,(0,o.kt)("img",{src:"https://i.imgur.com/YID4WId.png",border:"1"})),(0,o.kt)("h3",{id:"alert-manager"},"Alert Manager"),(0,o.kt)("p",null,"There is a configuration file named ",(0,o.kt)("inlineCode",{parentName:"p"},"alertmanager.yml")," inside the directory that you just extracted in the previous command, but that is not of our use. We will create our ",(0,o.kt)("inlineCode",{parentName:"p"},"alertmanager.yml")," file under ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/alertmanager")," with the following config."),(0,o.kt)("p",null,"Let\u2019s create the file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo touch /etc/alertmanager/alertmanager.yml\nsudo nano /etc/alertmanager/alertmanager.yml\n")),(0,o.kt)("p",null,"And add the ",(0,o.kt)("strong",{parentName:"p"},"Gmail configuration")," to it and save the file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"global:\n resolve_timeout: 1m\n\nroute:\n receiver: 'gmail-notifications'\n\nreceivers:\n- name: 'gmail-notifications'\n  email_configs:\n  - to: YOUR_EMAIL\n    from: YOUR_EMAIL\n    smarthost: smtp.gmail.com:587\n    auth_username: YOUR_EMAIL\n    auth_identity: YOUR_EMAIL\n    auth_password: YOUR_APP_PASSWORD\n    send_resolved: true\n")),(0,o.kt)("p",null,"With the above configuration, alerts will be sent using the email you set above. Remember to change ",(0,o.kt)("inlineCode",{parentName:"p"},"YOUR_EMAIL")," to your email and paste the app password you just saved earlier to the ",(0,o.kt)("inlineCode",{parentName:"p"},"YOUR_APP_PASSWORD"),". We will test the Alert Manager later in the guide."))}d.isMDXComponent=!0}}]);