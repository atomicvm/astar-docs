"use strict";(self.webpackChunkdocs_1=self.webpackChunkdocs_1||[]).push([[5603],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=o,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||r;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<r;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},1977:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return d}});var a=n(7462),o=n(3366),r=(n(7294),n(3905)),i=["components"],s={sidebar_position:2},l="2. Secure SSH Connection",c={unversionedId:"nodes/ultimateguide/secure_connection",id:"nodes/ultimateguide/secure_connection",title:"2. Secure SSH Connection",description:"SSH access is the most standard attack vector for an online server. An incredible number of robots and hackers scan the default port 22 and gain access, with basic and elaborated credentials.",source:"@site/docs/nodes/ultimateguide/secure_connection.md",sourceDirName:"nodes/ultimateguide",slug:"/nodes/ultimateguide/secure_connection",permalink:"/astar-docs/docs/nodes/ultimateguide/secure_connection",editUrl:"https://github.com/AstarNetwork/astar-docs/tree/main/docs/nodes/ultimateguide/secure_connection.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"1. Create Your Environnement",permalink:"/astar-docs/docs/nodes/ultimateguide/create_environnement"},next:{title:"3. SSH Tunneling",permalink:"/astar-docs/docs/nodes/ultimateguide/ssh_tunneling"}},p={},d=[{value:"Configuration",id:"configuration",level:2},{value:"Firewall",id:"firewall",level:3},{value:"Generate SSH keys",id:"generate-ssh-keys",level:3},{value:'Verify <a href="#0f49" id="0f49"></a>',id:"verify-",level:3},{value:'Connect <a href="#3255" id="3255"></a>',id:"connect-",level:3}],u={toc:d};function m(e){var t=e.components,n=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"2-secure-ssh-connection"},"2. Secure SSH Connection"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"SSH access")," is the most standard attack vector for an online server. An incredible number of robots and hackers scan the default port 22 and gain access, with basic and elaborated credentials."),(0,r.kt)("p",null,"In this part, we are going to build a ",(0,r.kt)("strong",{parentName:"p"},"secure SSH connection with strong SSH keys.")," We will ",(0,r.kt)("strong",{parentName:"p"},"change the default SSH port")," to mitigate scans and brute-force attempts."),(0,r.kt)("p",null,"We will use the ",(0,r.kt)("a",{parentName:"p",href:"https://git.libssh.org/projects/libssh.git/tree/doc/curve25519-sha256@libssh.org.txt"},(0,r.kt)("inlineCode",{parentName:"a"},"curve25519-sha256"))," protocol (",(0,r.kt)("strong",{parentName:"p"},"ECDH over Curve25519 with SHA2"),") for our keys here as this is considered the most secure nowadays."),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"This part is a modified version of ",(0,r.kt)("a",{parentName:"p",href:"https://medium.com/bld-nodes/securing-ssh-access-to-your-server-cc1324b9adf6"},"bLd's guide")," using only ",(0,r.kt)("strong",{parentName:"p"},"Putty")," client to access server. If you are using Linux or MacOS, you can refer directly to the original guide to use ",(0,r.kt)("strong",{parentName:"p"},"Open SSH"),"."))),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Follow this guide step-by-step, try to understand every step explained in this guide."))),(0,r.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Be very careful to never close your actual session until you\u2019ve tested the connection with your new key. You could lose access to your SSH connection."))),(0,r.kt)("p",null,"Connect to your server using ",(0,r.kt)("a",{parentName:"p",href:"https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html"},"PuTTy"),"."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Open PuTTY"),(0,r.kt)("li",{parentName:"ol"},"Typ in the field of \u2018",(0,r.kt)("strong",{parentName:"li"},"Host Name"),"\u2019 the IP of your server on Azure"),(0,r.kt)("li",{parentName:"ol"},"The terminal will open and you can log in with your username and password.")),(0,r.kt)("p",null,"Let\u2019s start by moving our actual unsecured host keys into a backup directory:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cd /etc/ssh\nsudo mkdir backup\nsudo mv ssh_host_* ./backup/\n")),(0,r.kt)("p",null,"Open the ",(0,r.kt)("inlineCode",{parentName:"p"},"ssh")," config file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo nano /etc/ssh/ssh_config\n")),(0,r.kt)("p",null,"Add the following lines in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Host *")," section and save:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Host *\n    KexAlgorithms curve25519-sha256@libssh.org\n    HostKeyAlgorithms ssh-ed25519-cert-v01@openssh.com,ssh-ed25519\n    Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr\n    MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com\n    PasswordAuthentication no\n    ChallengeResponseAuthentication no\n    PubkeyAuthentication yes\n    UseRoaming no\n")),(0,r.kt)("p",null,"Save ",(0,r.kt)("inlineCode",{parentName:"p"},"CTRL+O")," your file and close the editor ",(0,r.kt)("inlineCode",{parentName:"p"},"CTRL+X")),(0,r.kt)("p",null,"Open the ",(0,r.kt)("inlineCode",{parentName:"p"},"sshd")," config file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo nano /etc/ssh/sshd_config\n")),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"In the following lines, you see that I used port 4321, this is just an example. You can use any random port inside the range of 1024 and 49151. Copy these lines in your file:"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Port 22 \nPort 4321 \nKexAlgorithms curve25519-sha256@libssh.org \nHostKey /etc/ssh/ssh_host_ed25519_key \nCiphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr \nMACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com \nAllowGroups ssh-user \nPubkeyAuthentication yes \nPasswordAuthentication no \nChallengeResponseAuthentication no\n")),(0,r.kt)("p",null,"Save ",(0,r.kt)("inlineCode",{parentName:"p"},"CTRL+O")," your file and close the editor ",(0,r.kt)("inlineCode",{parentName:"p"},"CTRL+X")," .\\\nNow, what did you do? In details, by doing that, we tell the host to"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use the port  instead 4321 of default 22: please use a different random port in the range 1024\u201349151"),(0,r.kt)("li",{parentName:"ul"},"Use the ",(0,r.kt)("inlineCode",{parentName:"li"},"curve25519")," protocol for authentication"),(0,r.kt)("li",{parentName:"ul"},"Use ",(0,r.kt)("inlineCode",{parentName:"li"},"chacha20-poly1305")," (preferred), ",(0,r.kt)("inlineCode",{parentName:"li"},"aes-gmc")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"aes-ctr")," ciphers for data"),(0,r.kt)("li",{parentName:"ul"},"Enable ",(0,r.kt)("em",{parentName:"li"},"Message Authentication Code MAC")," for CTR ciphers"),(0,r.kt)("li",{parentName:"ul"},"Allow ssh group ssh-user"),(0,r.kt)("li",{parentName:"ul"},"Enable key authentication"),(0,r.kt)("li",{parentName:"ul"},"Disable password access")),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"We left here the line ",(0,r.kt)("inlineCode",{parentName:"p"},"Port 22")," for the first test on the new port. Once your tests are successful, we will remove this line."))),(0,r.kt)("p",null,"Then, create the new SSH host key:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'sudo ssh-keygen -t ed25519 -f ssh_host_ed25519_key -N ""\n')),(0,r.kt)("p",null,"Create the SSH user group and add your user to it. This will prevent any connection to an unexpected user:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo groupadd ssh-user\nsudo usermod -a -G ssh-user <username>\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note"),": you have to change ",(0,r.kt)("inlineCode",{parentName:"p"},"<username>")," by the user, you use on your server."),(0,r.kt)("h3",{id:"firewall"},"Firewall"),(0,r.kt)("p",null,"Before continuing, it is very important to open the newly configured SSH port in your firewall settings of your server (4321 in our example). For the first tests, you should let port 22 open. Once you successfully connected to the new port, you can safely close port 22."),(0,r.kt)("h3",{id:"generate-ssh-keys"},"Generate SSH keys"),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"This guide is build around Azure and PuTTy, in case you want to use OpenSSH follow ",(0,r.kt)("a",{parentName:"p",href:"https://medium.com/bld-nodes/securing-ssh-access-to-your-server-cc1324b9adf6"},"this guide"),"."))),(0,r.kt)("p",null,"Open PUTTYGen GUI:"),(0,r.kt)("center",null,(0,r.kt)("img",{src:"https://i.imgur.com/rkef1ah.png",border:"1"})),(0,r.kt)("p",null,"Select the ",(0,r.kt)("inlineCode",{parentName:"p"},"Ed25519"),"key type and click on ",(0,r.kt)("em",{parentName:"p"},"Generate"),":"),(0,r.kt)("center",null,(0,r.kt)("img",{src:"https://i.imgur.com/5kFNxJ6.png",border:"1"})),(0,r.kt)("p",null,"Enter a strong passphrase and save both private and public key in a secure folder. Copy the public key from the text box."),(0,r.kt)("p",null,"Go back to the PuTTy session on your ",(0,r.kt)("strong",{parentName:"p"},"server")," and open the ",(0,r.kt)("inlineCode",{parentName:"p"},"authorized_keys"),"file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo nano ~/.ssh/authorized_keys\n")),(0,r.kt)("p",null,"Paste the public key and save."),(0,r.kt)("h3",{id:"verify-"},"Verify ",(0,r.kt)("a",{href:"#0f49",id:"0f49"})),(0,r.kt)("p",null,"Let\u2019s restart the ",(0,r.kt)("inlineCode",{parentName:"p"},"ssh")," service without killing the current session:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo kill -SIGHUP $(pgrep -f 'sshd -D')\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Attention"),": you should not send a complete restart of ",(0,r.kt)("inlineCode",{parentName:"p"},"sshd")," for the moment, this would close your open session and potentially lose access to your server if something is set wrong."),(0,r.kt)("p",null,"Check that the ",(0,r.kt)("inlineCode",{parentName:"p"},"sshd")," service is still running correctly:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"systemctl status sshd\n")),(0,r.kt)("h3",{id:"connect-"},"Connect ",(0,r.kt)("a",{href:"#3255",id:"3255"})),(0,r.kt)("p",null,"Let\u2019s load the private key in the Putty ",(0,r.kt)("inlineCode",{parentName:"p"},"Auth")," section:"),(0,r.kt)("center",null,(0,r.kt)("img",{src:"https://i.imgur.com/vTtWZ0B.png",border:"1"})),(0,r.kt)("p",null,"Don\u2019t forget to use your custom port, then connect:"),(0,r.kt)("center",null,(0,r.kt)("img",{src:"https://i.imgur.com/nLgoXNu.png",border:"1"})),(0,r.kt)("p",null,"Congratulation, y",(0,r.kt)("strong",{parentName:"p"},"our SSH connection is secure"),"!"," "),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Don\u2019t forget to remove port 22 from ",(0,r.kt)("inlineCode",{parentName:"p"},"sshd_config")," file and firewall, and check that no other key is allowed in ",(0,r.kt)("inlineCode",{parentName:"p"},"authorized_keys")," file."))))}m.isMDXComponent=!0}}]);